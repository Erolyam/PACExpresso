// Generated by CoffeeScript 1.6.2
var MestestsPasser,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

MestestsPasser = (function() {
  MestestsPasser.Qaire = null;

  function MestestsPasser() {
    this.retrieveUserAnswer = __bind(this.retrieveUserAnswer, this);
    this.handleUserAnswer = __bind(this.handleUserAnswer, this);
    this.handlerClickOnFooterButton = __bind(this.handlerClickOnFooterButton, this);
    this.handlerClickOnLi = __bind(this.handlerClickOnLi, this);    this.Qaire = window.jsp.qaire;
    this.Qaire.submited_data_json = JSON.parse(this.Qaire.submited_data_json);
    if (this.Qaire.submited_data_json === null) {
      this.Qaire.submited_data_json = _.times(JSON.parse(this.Qaire.questionAlineas_json).length, function() {
        return 0;
      });
    }
  }

  MestestsPasser.prototype.go = function() {
    this.renderLis();
    $(".passer .qtabctn").on("click", "li", this.handlerClickOnLi);
    $(".passer footer").on("click", "button", this.handlerClickOnFooterButton);
    return $(".passer .qtabctn li").first().trigger('click');
  };

  MestestsPasser.prototype.renderLis = function() {
    var html, target;

    target = $(".passer .qtabctn ul");
    target.empty();
    _.forEach(JSON.parse(this.Qaire.questionAlineas_json), function(alineaId, index) {
      var html;

      html = "<li data-alineaid='" + alineaId + "'' data-num='" + index + "'>" + (index + 1) + "</li>";
      return target.append($(html));
    });
    html = "<li>#</li>";
    return target.append($(html));
  };

  MestestsPasser.prototype.handlerClickOnLi = function(e) {
    var alinea, alineaId, context, curWeight, html, li, num, target, targetAnswers, total, tpl;

    this.handleUserAnswer();
    li = $(e.currentTarget);
    alineaId = li.data('alineaid');
    target = $('.passer .qbodyctn');
    target.empty();
    li.siblings().removeClass("selected");
    li.addClass("selected");
    $("footer button").removeClass("disabled");
    if (li.prev().length === 0) {
      $("footer button.actionprev").addClass("disabled");
    }
    if (li.next().length === 0) {
      $("footer button.actionnext").addClass("disabled");
    }
    if ((alineaId != null)) {
      alinea = this.Qaire.aAlineas[alineaId];
      context = this.Qaire.aContexts[alinea.question_id];
      num = li.data("num");
      tpl = _.template($('#tplqContext').html().trim());
      html = tpl({
        title: context.title,
        body: context.context
      });
      target.append(html);
      tpl = _.template($('#tplqAlinea').html().trim());
      html = tpl({
        body: alinea.body
      });
      target.append(html);
      targetAnswers = target.find(".alineaanswers");
      tpl = _.template($('#tplqAlineaAnswer').html().trim());
      total = this.Qaire.submited_data_json[num];
      curWeight = 1;
      return _.forEach(JSON.parse(alinea.answers), function(answer, index) {
        var checked;

        checked = "";
        if (total & curWeight) {
          checked = "checked";
        }
        curWeight <<= 1;
        html = tpl({
          body: answer,
          letter: String.fromCharCode(65 + index),
          checked: checked
        });
        return targetAnswers.append(html);
      });
    } else {

    }
  };

  MestestsPasser.prototype.handlerClickOnFooterButton = function(e) {
    var button, li;

    button = $(e.currentTarget);
    li = $(".passer .qtabctn li.selected");
    if (button.hasClass('actionnext')) {
      return li.next().trigger('click');
    } else if (button.hasClass('actionprev')) {
      return li.prev().trigger('click');
    }
  };

  /*
    Récupère les croix de l'étudiant et met à jour @Qaire
    A appeler à chaque fois qu'on change de page
    Envoie au serveur
  */


  MestestsPasser.prototype.handleUserAnswer = function() {
    var newsub, res, url;

    res = this.retrieveUserAnswer();
    if (res === null) {
      return;
    }
    newsub = _.clone(this.Qaire.submited_data_json);
    newsub[res.num] = res.val;
    if (_.isEqual(newsub, this.Qaire.submited_data_json)) {
      return;
    }
    this.Qaire.submited_data_json = newsub;
    url = window.jsp.aUrls.thistst;
    return $.ajax({
      url: url,
      method: 'POST',
      data: {
        _method: 'PUT',
        values: JSON.stringify(newsub)
      }
    }).fail(function(jqXHR, textStatus, errorThrown) {
      return alert("Erreur lors de l'enregistrement");
    });
  };

  /*
    Renvoie le résultat coché, en un nombre bitwise
    @returns null ou {num:, val:}
  */


  MestestsPasser.prototype.retrieveUserAnswer = function() {
    var aChks, curIndex, curWeight, li, total;

    li = $(".passer .qtabctn li.selected");
    curIndex = li.data("num");
    if (curIndex == null) {
      return null;
    }
    aChks = $(".passer .alineaanswers").find(".letter input[type=checkbox]");
    curWeight = 1;
    total = 0;
    _.each(aChks, function(elem) {
      if ($(elem).prop("checked")) {
        total += curWeight;
      }
      return curWeight <<= 1;
    });
    return {
      num: curIndex,
      val: total
    };
  };

  return MestestsPasser;

})();
